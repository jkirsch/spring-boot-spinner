var myApp=angular.module("spinner",["spinner.controllers","ngAnimate"]);
angular.module("spinner.controllers",["spinner.services","toaster"]).controller("EntriesCtrl",["$scope","myService","toaster","$timeout","$log","$window",function(a,h,d,m,e,f){function k(){e.log("STOMP: Attempting connection");q=new SockJS("/spinner");g=Stomp.over(q);g.connect({},r,t)}var q,g;a.participants=[];a.winner="";a.newName="";a.connected=0;a.spinning=!1;a.add=function(b){b={name:a.newName.trim()};d.clear();h.create(b).then(function(c){a.newName=""},function(a){d.pop("error","Backend error",
a.message);e.log(a)})};var l=function(b){a.spinning||(n.update(p()),a.$apply())},u=function(b){a.spinning=!0;var c;for(c=0;c<a.participants.length&&a.participants[c].id!==b.id;c++);n.update(p());var h=n.spin(360/a.participants.length*(a.participants.length-c-1)+360+360/a.participants.length/2+7200);m(function(){a.winner=b;a.participants[c]=b;a.spinning=!1;a.$apply();d.pop("success","Selected",b.name)},h.duration)},r=function(b){e.log("Connected "+b);g.subscribe("/app/participants",function(c){c=angular.fromJson(c.body);
a.participants=c.entries;a.connected=c.connected;l()});g.subscribe("/topic/added",function(c){c=angular.fromJson(c.body);a.participants.push(c);l()});g.subscribe("/topic/deleted",function(c){c=angular.fromJson(c.body);var b;for(b=0;b<a.participants.length&&a.participants[b].id!==c;b++);a.participants.splice(b,1);l()});g.subscribe("/topic/spin",function(a){u(angular.fromJson(a.body))});g.subscribe("/topic/count",function(b){b=angular.fromJson(b.body);a.connected=b;l()})},t=function(b){a.connected=
0;l();e.log("STOMP: "+b);m(k,1E4);e.log("STOMP: Reconnecting in 10 seconds")};k();a.remove=function(a){g.send("/app/remove",{},JSON.stringify(a.id))};var p=function(){var b=[];angular.forEach(a.participants,function(a){this.push(a.name.substring(0,8))},b);return b};f=Math.min(f.innerWidth/2,220)-20;var n=new Spinner("#spinnerContainer",{margins:{top:40,right:10,bottom:10,left:10},outerR:f,h:450,w:2*f+20,data:p()});a.spin=function(){d.clear();h.spin().then(function(b){a.winner=""},function(a){d.pop("error",
"Backend error",a.message);e.log(a)})};a.info=function(){1<a.connected||0===a.connected?d.pop("info","Clients","Currently there are "+a.connected+" Clients"):d.pop("info","Clients","Currently there is "+a.connected+" Client connected")}}]);
myApp=angular.module("spinner.services",[]).factory("myService",["$http",function(a){return{create:function(h){return a.post("participants/",h).then(function(a){return a.data},function(a,h,e,f){var k;a.data&&(k=a.data.message);throw Error(k||"Can't talk to server - server down?");})},spin:function(){return a.get("participants/random").then(function(a){return a.data},function(a,d,m,e){var f;a.data&&(f=a.data.message);throw Error(f||"Can't talk to server - server down?");})}}}]);